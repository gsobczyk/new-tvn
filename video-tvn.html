<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>TVN Player - Video</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="icon" type="image/x-icon" href="favicon.ico" />

	<script src="js/jquery-1.10.2.min.js" type="text/javascript"></script>
	<script src="js/jsrender.js" type="text/javascript"></script>
	<script src="js/jquery.ba-bbq.js" type="text/javascript"></script>
	<script src="js/utils.js" type="text/javascript"></script>

	<link rel="stylesheet" type="text/css" href="css/kube.min.css" />
	<link rel="stylesheet" type="text/css" href="css/master.css" />
	<script type="text/javascript" src="js/kube.tabs.js"></script>

	<link href="css/video-js.css" rel="stylesheet">
	<script src="js/video.js"></script>
	<script>
	  videojs.options.flash.swf = "video-js.swf"
	</script>

<script type="text/javascript">
	$(document).ready(function(){
		var params = $.deparam.querystring(true);
		var only_first = params.only_first;
		if (only_first==undefined) only_first = true;
		var resolution = '&deviceScreenHeight=1080&deviceScreenWidth=1920';
		var infoUrl = base_url + '&m=getItem&type=' + params.type + '&id=' + params.id + resolution + '&callback=?';
		// console.log("itemUrl: "+infoUrl);
		$.getJSON(infoUrl, function(data){
			var videos = data.item.videos.main.video_content;
			var poster = 'http://redir.atmcdn.pl/scale/o2/tvn/web-content/m/'+data.item.thumbnail[0].url+'?quality=70&srcmode=0&type='+data.item.type_episode+'&srcx='+data.item.thumbnail[0].srcx+'&srcy='+
					data.item.thumbnail[0].srcy+'&srcw='+data.item.thumbnail[0].srcw+'&srch='+data.item.thumbnail[0].srch+'&dstw=720&dsth=405';
			data.movies = [];
			var max = videos.length;
			if (only_first) max = 1;
			for (var i = 0; i < max; i++) {
				var v = videos[i];
				var urlFileName = v.url;
				var proxy = 'http://www.corsproxy.com/' + urlFileName.replace('http://tvnplayer.pl', 'player.pl');
				var video_url;
				$.ajax({
					url: proxy, 
					success: function(response){
						video_url = response;
					},
					async: false
				});
				data.only_first = only_first;
				data.query_string = document.location.search;
				data.movies.push({
					"movie" : video_url,
					"label" : v.profile_name,
					"poster" : poster,
					"w": 720,
					"h": 405,
					"index" : i
				});

			};
			$("#content").html(
				$("#tabsTemplate").render(data)
			);
			try {
				$('nav[data-toggle="tabs"]').tabs();
			} catch (err) {}
		});
	});
</script>
<script id="tabsTemplate" type="text/x-jsrender">
	<h1>{{:item.serie_title}}</h1>
	<h1 class="subheader">{{:item.title}}</h1>
	{{if item.season!=0 && item.episode!=0}}
		<h2>Sezon {{:item.season}}, epizod {{:item.episode}}</h2>
	{{/if}}
	<nav class="nav-tabs" data-toggle="tabs" data-height="equal">
	    <ul>
			{{for movies}}
				<li><a href="#tab{{>index}}" {{if index==0}}class="active"{{/if}}>{{>label}}</a></li>
			{{/for}}
			{{if only_first}}
				<li><a href="{{>query_string}}&only_first=false">WiÄ™cej</a></li>
			{{/if}}
	    </ul>
	</nav>
	{{for movies}}
		<div id="tab{{>index}}">
			<video id="player{{>index}}" class="video-js vjs-default-skin" controls preload="auto" width="{{>w}}" height="{{>h}}" poster="{{>poster}}" data-setup='{"autoplay": "false"}'>
			 	<source src="{{>movie}}" type='video/mp4' />
			</video>
			<a href="{{>movie}}">Pobierz</a>
		</div>
	{{/for}}
	<p>{{:item.lead}}</p>
</script>
</head>
<body>
	<div class="wrapper" id="content">
	</div>
</body>
</html>
